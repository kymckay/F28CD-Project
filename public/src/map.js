/* global mapboxgl, MapboxGeocoder */ // Defined by Mapbox GL JS

export async function initMap(apiKey) {
  // If key wasn't set (or failed to inject) don't initalise the map section
  if (!apiKey) {
    document.getElementById("map").innerHTML = "Map appears here. API key not configured (see contributing guidelines).";
    return;
  }

  // Include fs module
  // const fs = require('fs');
  // const constitency = JSON.parse(fs.readFileSync('data/constituencies.geojson'));
  // const constName = JSON.parse(fs.readFileSync('data/constituencies.geojson').properties.pcon19nm);
  // const constPoly = JSON.parse(fs.readFileSync('data/constituencies.geojson').properties.coordinates);

  const long = -3.1883;
  const lat = 55.9533;
  const coor = [long, lat];
  mapboxgl.accessToken = apiKey;
  const map = new mapboxgl.Map({
    container: 'map', // ID in the HTML
    style: 'mapbox://styles/mapbox/light-v10',
    center: coor,
    zoom: 12,
  });

  const geocoder = new MapboxGeocoder({
    accessToken: apiKey,
    mapboxgl: mapboxgl,
    placeholder: 'Search for places in United Kingdom',
    bbox: [-8.196671, 50.064075, 1.737475, 60.917070],
    proximity: {
      longitude: long,
      latitude: lat
    },
    marker: false
  });

  // Add the geocoder to the map
  map.addControl(geocoder);

  // After the map style has loaded on the page,
  // add a source layer and default styling for a single point
  map.on('load', function () {
    map.addSource('single-point', {
      type: 'geojson',
      data: {
        type: 'FeatureCollection',
        features: []
      }
    });

    // constPoly.forEach(e => {
    //   map.addSource(
    //     constName[e].toString(), {
    //       'type': 'geojson',
    //       'data': {
    //         'type': 'Feature',
    //         'geometry': {
    //           'type': 'Polygon',
    //           'coordinates': constPoly[e].toString
    //         }
    //       }
    //     }
    //   );
    //   map.addLayer({
    //     'id': constName[e].toString(),
    //     'type': 'fill',
    //     'source': constName[e].toString(),
    //     'layout': {},
    //     'paint': {
    //     'fill-color': '#088',
    //     'fill-opacity': 0.8
    //     }
    //   });
    // });
    map.addSource('Edinburgh North and Leith', {
      'type': 'geojson', 
      'data': {
        'type': 'Feature',
        'geometry': {
          'type': 'Polygon',
          'coordinates': [ 
            [ 
              [ -3.140967622205752, 55.972424806983639 ], 
              [ -3.14107267013343, 55.972491680650243 ], 
              [ -3.151260986859202, 55.976137470716182 ], 
              [ -3.151524904192233, 55.976873570937286 ], 
              [ -3.152450266940861, 55.977009630390434 ], 
              [ -3.155389340416527, 55.978948077398158 ], 
              [ -3.157196007499449, 55.981917812956112 ], 
              [ -3.179577361321418, 55.989588460823377 ], 
              [ -3.182241378040801, 55.991367226754477 ], 
              [ -3.18254832094778, 55.991234029994466 ], 
              [ -3.180008991946245, 55.989444195237539 ], [ -3.181138019586573, 55.988726244963942 ], [ -3.18158745273157, 55.988853983932806 ], [ -3.180819651715636, 55.98822427954515 ], [ -3.184592769851841, 55.988109909162461 ], [ -3.185485303860565, 55.988780610241307 ], [ -3.184653103175667, 55.989295427985702 ], [ -3.194374407996762, 55.98543219403544 ], [ -3.195636274582067, 55.984879008171021 ], [ -3.196357033158132, 55.983930338076085 ], [ -3.19595003195441, 55.982321434770704 ], [ -3.196584804693993, 55.982281387210797 ], [ -3.195208967194043, 55.982303472392189 ], [ -3.195473454470018, 55.981055548969934 ], [ -3.196896471597083, 55.98084762212315 ], [ -3.196831743905548, 55.981917548226669 ], [ -3.197057069289, 55.980699645302145 ], [ -3.202424374531089, 55.980038195095098 ], [ -3.206255556009098, 55.980269419146445 ], [ -3.206799083462454, 55.980533575874595 ], [ -3.206850126179651, 55.980318390537036 ], [ -3.213593975177715, 55.980775929014627 ], [ -3.216890911958761, 55.980270836196567 ], [ -3.218245817070903, 55.980550370111665 ], [ -3.217591084028444, 55.985928252474878 ], [ -3.220657599913133, 55.98786569113399 ], [ -3.217749533721344, 55.985919500821055 ], [ -3.218417907644306, 55.980362638789309 ], [ -3.218877157926617, 55.980288929836526 ], [ -3.221917054446968, 55.980787174783622 ], [ -3.223180648463943, 55.981516780688729 ], [ -3.22274786734016, 55.982990184737673 ], [ -3.223112728630236, 55.982768195853481 ], [ -3.223066525024651, 55.983029240425729 ], [ -3.221569200476478, 55.986069516632782 ], [ -3.223508280170063, 55.985547054000143 ], [ -3.223015620488187, 55.985531285670518 ], [ -3.223343751292227, 55.984651929653843 ], [ -3.225952415080367, 55.985033010655755 ], [ -3.226069339496151, 55.985942079555834 ], [ -3.228021105303271, 55.987088973296494 ], [ -3.222665853119476, 55.987500744486951 ], [ -3.222589860242419, 55.987835751088731 ], [ -3.229983652279877, 55.987102630675324 ], [ -3.233859763191269, 55.983688025986098 ], [ -3.237803204287027, 55.984105872971163 ], [ -3.239587722606424, 55.983223509750694 ], [ -3.241328458175748, 55.983525859365372 ], [ -3.249815319655195, 55.983871314524336 ], [ -3.252834681882884, 55.982934865359582 ], [ -3.252209717771713, 55.980248433715786 ], [ -3.254476418293552, 55.979326823915336 ], [ -3.255107579904873, 55.978281719225905 ], [ -3.256080513308079, 55.977643723428152 ], [ -3.25468530826284, 55.976671378548858 ], [ -3.253102189228585, 55.972665712293654 ], [ -3.248567333060801, 55.967187695407397 ], [ -3.23980845099635, 55.968135213754842 ], [ -3.24191220238563, 55.964391468940377 ], [ -3.241838975797648, 55.96380457006093 ], [ -3.24419681251775, 55.961201151786085 ], [ -3.251170327778997, 55.960579646135187 ], [ -3.258014586608096, 55.960814442507086 ], [ -3.259624337566885, 55.958593911116424 ], [ -3.256579882423546, 55.952333630918467 ], [ -3.252906079388902, 55.954217575093104 ], [ -3.252569227833206, 55.954103333526504 ], [ -3.249752581584019, 55.955109555964633 ], [ -3.250022291351444, 55.955926207951507 ], [ -3.249418887125519, 55.956432845666733 ], [ -3.24797909712123, 55.956884998505046 ], [ -3.245190388460117, 55.956678805323435 ], [ -3.24429933851238, 55.956512568510121 ], [ -3.241347904177622, 55.953726438912057 ], [ -3.23649440989535, 55.951438328377193 ], [ -3.234011532117671, 55.949156715602498 ], [ -3.229744522048179, 55.950891347369279 ], [ -3.227839477800487, 55.949799755494858 ], [ -3.22783355783599, 55.949412576333458 ], [ -3.225889386034651, 55.949104889005547 ], [ -3.224092698762002, 55.9492062983986 ], [ -3.221920775482109, 55.949853231360173 ], [ -3.221921244921863, 55.950936877790085 ], [ -3.221292540550902, 55.951010483192285 ], [ -3.215136215202262, 55.947059465652771 ], [ -3.208585183287577, 55.949977516185399 ], [ -3.207108378474281, 55.950222922112566 ], [ -3.18532043503285, 55.954003973987611 ], [ -3.183384050540586, 55.95389411242185 ], [ -3.181585342496887, 55.953206041144391 ], [ -3.178719275214001, 55.953538953093833 ], [ -3.172279219787593, 55.956336219628668 ], [ -3.17271307723349, 55.956857756178287 ], [ -3.172046305373884, 55.957529879624083 ], [ -3.170185705847672, 55.965615330525573 ], [ -3.171547473095865, 55.965775766338055 ], [ -3.17013692826489, 55.968086738051468 ], [ -3.168839874571079, 55.96768295935879 ], [ -3.166815993011609, 55.969054482897526 ], [ -3.160200332704965, 55.969844745332281 ], [ -3.152368079852435, 55.970251609607715 ], [ -3.151824903606511, 55.971493967297995 ], [ -3.144778122618142, 55.969483131591019 ], [ -3.140967622205752, 55.972424806983639 ] 
            ] 
          ] 
        }
      }
    });
    map.addLayer({
      'id': 'Edinburgh North and Leith',
      'type': 'fill',
      'source': 'Edinburgh North and Leith',
      'layout': {},
      'paint': {
        'fill-color': '#088',
        'fill-opacity': '0.8'
      }
    });

    map.addLayer({
      id: 'point',
      source: 'single-point',
      type: 'circle',
      paint: {
        'circle-radius': 10,
        'circle-color': '#448ee4'
      }
    });

    // Listen for the `result` event from the Geocoder
    // `result` event is triggered when a user makes a selection
    //  Add a marker at the result's coordinates
    geocoder.on('result', function (e) {
      map.getSource('single-point').setData(e.result.geometry);
    });
  });
}